function uniqueId(){return String(Math.random().toString(16).slice(2))}function arrRemove(e,t){t=e.indexOf(t);-1<t&&e.splice(t,1)}function findTemplates(){var t=document.getElementById("nodel").children,n=[];for(let e=0;e<t.length;e++){var i=t[e];n.push(i.id)}return n}function toRegPos(e){var t=document.getElementById("nodel");return[e.x+t.offsetWidth/2,e.y+t.offsetHeight/2]}class Nodel{static fromJSON(e){return new Nodel(e.id,e.template,e.x,e.y,e.data,e.parents,e.children,e.group)}constructor(e,t,n,i,s,r={},o={},d={name:null,collapsed:!1,ends:[]}){this.id=e,this.template=t,this.x=n,this.y=i,this.data=s,this.parents=r,this.children=o,this.group=d}isLeaf(){return!Object.values(this.children)?.length}isHead(){return!Object.values(this.parents)?.length}isGroup(e=null){return!(!this.group.ends.length&&!this.group.name||null!==e&&this.group.collapsed!==e)}groupAllChildren(e){this.group.ends=this.getLeaves(e)}parentGroupNodes(e,t=[]){if(t.includes(this.id))return[];t.push(this.id);let n=[];for(var[i,s]of Object.entries(this.parents))for(const o of s){var r=e[o];r.isGroup()&&n.push(r.id),n=n.concat(r.parentGroupNodes(e,t))}return n}hasChild(e,t,n=null){if(this.id===t)return!0;if(this.id!==n)for(var[i,s]of Object.entries(this.children))for(const r of s)if(e[r].hasChild(e,t,n))return!0;return!1}moveConnection(e,t,n,i){e[n].splice(e[n].indexOf(t),1),e[i]||(e[i]=[]),e[i].push(t)}moveParent(e,t,n){this.moveConnection(this.parents,e,t,n)}moveChild(e,t,n){this.moveConnection(this.children,e,t,n)}isDirectChild(e,t){return!!this.children[t]?.includes(e)}groupContains(e,t){for(const n of this.group.ends)if(this.hasChild(e,t,n))return!0;return!1}getInvolvedGroupNodes(e){var t=[];for(const i of this.parentGroupNodes(e)){var n=e[i];n.groupContains(e,this.id)&&t.push(n)}return t}isVisible(e){for(const t of this.getInvolvedGroupNodes(e))if(this.id!=t.id&&t.group.collapsed&&t.groupContains(e,this.id))return!1;return!0}getLeaves(e,t=[]){if(t.includes(this.id))return[];if(t.push(this.id),this.isLeaf())return[this.id];let n=[];for(var[i,s]of Object.entries(this.children))for(const o of s){var r=e[o];n=n.concat(r.getLeaves(e,t))}return n}distanceTo(e){return Math.sqrt((this.x-e.x)**2+(this.y-e.y)**2)}}class NodelEvent{static TYPES={Node:0,Connection:1};constructor(e,t,n=null){var i=document.getElementById("nodel");switch(this.elem=t.target,this.x=t.x-i.offsetWidth/2,this.y=t.y-i.offsetHeight/2,e){case NodelEvent.TYPES.Node:this.node=n;break;case NodelEvent.TYPES.Connection:this.nodes=n;break;default:console.error("Unknown NodelEvent type: "+e)}}}class NodelManager{constructor(e){this.nodes={},this.render=e,this.isDrawingPaused=0,this.onDrawCallbacks=[]}isEmpty(){return!Object.keys(this.nodes).length}exists(e){return e&&e in this.nodes}verify(e,t=!0){return this.exists(e)===t}verifyBoth(e,t,n=0){return this.verify(e)&&this.verify(t)}onDraw(e){this.onDrawCallbacks.push(e)}redraw(){if(this.isDrawingPaused)console.warn("skipping draw request, drawing is paused");else{this.render.draw(this.nodes);for(const e of this.onDrawCallbacks)e()}}pauseDraw(){this.isDrawingPaused+=1}unpauseDraw(){--this.isDrawingPaused,this.isDrawingPaused<0&&console.error("Something has gone terribly wrong"),this.redraw()}addNode(e,t,n,i){var s;return this.render.verify(e)?(s=uniqueId(),this.nodes[s]=new Nodel(s,e,t,n,i),this.redraw(),s):null}createGroup(e,t){this.verify(e)&&((e=this.nodes[e]).group.name=t,e.groupAllChildren(this.nodes),this.redraw())}toggleGroup(e,t=null){var n;this.verify(e)&&((n=this.nodes[e]).group.ends.length||this.createGroup(e,n.data.name+" group"),n.group.collapsed=null==t?!n.group.collapsed:t,this.redraw())}deleteNode(e){if(this.verify(e)){const i=this.nodes[e];delete this.nodes[e],this.eachChild(i,e=>{for(var[t,n]of Object.entries(e.parents))i.id in n&&e.parents[t].splice(n.indexOf(i.id),1)}),this.eachParent(parent,e=>{for(var[t,n]of Object.entries(parent.children))i.id in n&&parent.children[t].splice(n.indexOf(i.id),1)}),this.redraw()}}toggleConnect(e,t,n="default"){if(this.verifyBoth(e,t)){var i=this.nodes[e];if(i.group.collapsed)for(const s of i.group.ends)return void this.toggleConnect(s,t,n);i.isDirectChild(t,n)?this.disconnectNodes(e,t,n):this.connectNodes(e,t,n),this.redraw()}}getConnectionType(e,t){if(this.verifyBoth(e,t)){var n,i,e=this.nodes[e];for([n,i]of Object.entries(e.children))if(i.includes(t))return n;return null}}setConnectionType(e,t,n){var i;this.verifyBoth(e,t)&&(i=this.getConnectionType(e,t),this.nodes[e].moveChild(t,i,n),this.nodes[t].moveParent(e,i,n),this.redraw())}connectNodes(e,t,n){var i,s;this.verifyBoth(e,t)&&(i=this.nodes[e].children,s=this.nodes[t].parents,n in i||(i[n]=[]),n in s||(s[n]=[]),i[n].push(t),s[n].push(e))}disconnectNodes(e,t,n){var i=this.nodes[e].children,s=this.nodes[t].parents;arrRemove(i[n],t),arrRemove(s[n],e)}moveNode(e,t,n){if(this.verify(e)){e=this.nodes[e];const i=t-e.x,s=n-e.y;e.x=t,e.y=n,e.isGroup()&&e.group.collapsed&&this.eachChild(e,(e,t)=>{e.x+=i,e.y+=s},e.group.ends),this.redraw()}}getHeads(){return Object.values(this.nodes).filter(e=>e.isHead())}eachChild(e,t,n=[]){this.eachConnection(e.children,t,n)}eachParent(e,t,n=[]){this.eachConnection(e.parents,t,n)}eachConnection(e,t,n=[]){if(e)for(var[i,s]of Object.entries(e))for(const r of s)r in n||t(this.nodes[r],i)}getDirectNodes(e){var t,n,i={};for([t,n]of Object.entries(e)){t in i||(i[t]=[]);for(const s of n)i[t].push(s.id)}return i}createGroupMap(e,t=null,n=0,i=0){if(t=t||e.group.ends,e.id in t)return null;var s,r,o={};for([s,r]of Object.entries(e.children)){s in o||(o[s]=[]);for(const l of r){var d=this.nodes[l],d=this.createGroupMap(d,t,e.x,e.y);o[s].push(d)}}return{id:e.id,moduleId:e.data.name,offsetX:e.x-n,offsetY:e.y-i,parents:t?e.parents:null,children:o||null}}createFromMap(e,t,n,i=null,s=()=>null,r,o={},d=null){var l=i??o[e.id]??s(e,t,n);if(!(e.id in o)){o[e.id]=l;for(var[a,h]of Object.entries(e.children))for(const c of h)this.createFromMap(c,l.x,l.y,null,s,null,o,{type:a,parentId:l.id})}i=JSON.stringify;return d&&(this.connectNodes(d.parentId,l.id,d.type),l.conn.push(i(d))),l.id}load(e){for(const t of e)this.nodes[t.id]=Nodel.fromJSON(t);this.redraw()}}class NodelRender{constructor(){this.recenter(),this.resetScale(),this.templates=findTemplates(),this.pencil=jsPlumbBrowserUI.newInstance({container:document.getElementById("nodel")}),this.hideTemplates=!1,this.toggleTemplates(),this.connectionBinding={},this.connectionColorCallback=()=>"#ad00d9",this.connectionLabelCallback=()=>"",this.helpers={"connection-color":()=>"#ad00d9","connection-label":()=>""}}toggleTemplates(){this.hideTemplates=!this.hideTemplates;for(const e of this.templates)document.getElementById(e).hidden=this.hideTemplates}clear(){var t=document.getElementById("nodel");this.pencil.deleteEveryConnection();for(let e=t.children.length-1;0<=e;e--){var n=t.children[e];this.templates.includes(n.id)||t.removeChild(n)}}on(e,t){this.helpers[e]=t}draw(n){var e=document.getElementById("nodel"),i=(this.clear(),Object.values(n).filter(e=>e.isVisible(n)));for(const u of i){var t,s,r=document.getElementById(u.template).cloneNode(!0),o=(e.appendChild(r),r.id=u.id,r.hidden=!1,u.isGroup(!0)&&r.classList.add("group"),u.group.collapsed?u.group:u.data);for([t,s]of Object.entries(o))r.innerHTML=r.innerHTML.replaceAll(`{${t}}`,s);var[o,d]=toRegPos(u);r.style.position="absolute",r.style.left=o-r.offsetWidth/2+"px",r.style.top=d-r.offsetHeight/2+"px"}for(const p of i)for(const f of p.group.collapsed?p.group.ends:[p.id]){var l,a,h=n[f];for([l,a]of Object.entries(h.children))for(const g of a){const v=n[g];p.id;let e=null,t=!1;i.includes(v)?e=v.id:(c=v.getInvolvedGroupNodes(n).reverse().find(e=>e.group.collapsed),e=c.id,t=!0);var c=this.drawConnection(p,v,l,t);const m=this.connectionBinding;m&&c.connector.path.addEventListener(m.eventType,e=>{m.callback(e,[p.id,v.id])})}}}drawConnection(e,t,n,i=!1){var[s,r]=[e.id,t.id],s=document.getElementById(s),r=document.getElementById(r),o=this.helpers["connection-color"](n),n=this.helpers["connection-label"](e,t,n),o={strokeWidth:6,stroke:o},i=this.pencil.connect({source:s,target:r,anchor:"Continuous",paintStyle:i?{...o,dashstyle:"3"}:o,overlays:[{type:"Arrow",options:{location:1}},{type:"Label",options:{label:n,cssClass:"line-label"}}],connector:this.connectionType(e,t)});return this.pencil.setDraggable(s,!1),this.pencil.setDraggable(r,!1),i}connectionType(e,t,n=300){return e.id==t.id?"StateMachine":e.distanceTo(t)<n?"Straight":"Bezier"}addConnectionBinding(e,t){this.connectionBinding={eventType:e,callback:t}}verify(e,t=!0){return!(!e||this.templates.includes(e)!=t)||(console.error(`(nodel) ${t?"couldn't find":"found"} template #`+e),!1)}recenter(){self.x=0,self.y=0}panView(e,t){self.x+=e,self.y+=t}adjustScale(e){this.scale+=e}setScale(e){this.scale=e}resetScale(){this.scale=1}}class NodelListener{constructor(e,t){this.manager=e,this.render=t}on(e,i,t=!1){t?(this.render.addConnectionBinding(e,(e,t)=>{t=t.map(e=>this.manager.nodes[e]);i(new NodelEvent(NodelEvent.TYPES.Connection,e,t))}),this.manager.redraw()):document.getElementById("nodel").addEventListener(e,e=>{var t=e.target?.id;let n=null;t&&this.manager.verify(t,!0)&&(n=this.manager.nodes[t]);t=new NodelEvent(NodelEvent.TYPES.Node,e,n);i(t)})}}
